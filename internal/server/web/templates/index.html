<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{ .Data.Title }}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ .CSRFToken }}">
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="{{ .Data.Title }}">
    <meta name="description" content="{{ index .Data.Settings "meta_description" }}">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ .Data.HeaderLinkURL }}">
    <meta property="og:title" content="{{ .Data.Title }}">
    <meta property="og:description" content="{{ index .Data.Settings "meta_description" }}">
    {{ if index .Data.Settings "meta_image_url" }}
    <meta property="og:image" content="{{ .Data.SiteURL }}/static/images/{{ index .Data.Settings "meta_image_url" }}">
    {{ end }}

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ .Data.HeaderLinkURL }}">
    <meta property="twitter:title" content="{{ .Data.Title }}">
    <meta property="twitter:description" content="{{ index .Data.Settings "meta_description" }}">
    {{ if index .Data.Settings "meta_image_url" }}
    <meta name="twitter:image" content="{{ .Data.SiteURL }}/static/images/{{ index .Data.Settings "meta_image_url" }}">
    {{ end }}

    <link rel="icon" type="image/x-icon" href="/static/images/{{ index .Data.Settings "favicon_url" }}">
    <link rel="alternate" type="application/rss+xml" title="{{ .Data.Title }} Feed" href="/rss.xml" />
    
    <!-- External CSS -->
    <link rel="stylesheet" href="{{ themeCSSPublic .Data.Settings "variables.css" }}" id="themeVariablesCSS">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="{{ themeCSSPublic .Data.Settings "public.css" }}" id="themePublicCSS">
    <link rel="stylesheet" href="{{ themeCSSPublic .Data.Settings "ux-enhancements.css" }}" id="themeUxCSS">
    
    {{ if .Data.AllowPublicThemeSelection }}
    <!-- Theme switching script - must run before page render -->
    <script>
        // Check for user's theme preference and update CSS links before page loads
        (function() {
            let userTheme;
            try {
                userTheme = localStorage.getItem('userSelectedTheme');
            } catch (error) {
                console.warn('localStorage access blocked:', error);
                return; // Exit gracefully if localStorage is not available
            }
            
            if (userTheme) {
                // Security: Validate theme name against allowed themes list
                const allowedThemes = [{{ range $i, $theme := .Data.AvailableThemes }}{{ if $i }}, {{ end }}'{{ $theme }}'{{ end }}];
                
                // Edge case: If no themes available, clear localStorage and exit
                if (allowedThemes.length === 0) {
                    try {
                        localStorage.removeItem('userSelectedTheme');
                    } catch (error) {
                        // Ignore localStorage errors during cleanup
                    }
                    return;
                }
                
                // Only proceed if theme is in allowed list and contains only safe characters
                if (allowedThemes.includes(userTheme) && /^[a-zA-Z0-9_-]+$/.test(userTheme)) {
                    const variablesLink = document.getElementById('themeVariablesCSS');
                    const publicLink = document.getElementById('themePublicCSS');
                    const uxLink = document.getElementById('themeUxCSS');
                    
                    // Use encodeURIComponent for additional safety
                    const safeTheme = encodeURIComponent(userTheme);
                    try {
                        // Apply theme changes atomically to prevent visual glitches
                        const tempLinks = {
                            variables: variablesLink ? variablesLink.cloneNode() : null,
                            public: publicLink ? publicLink.cloneNode() : null,
                            ux: uxLink ? uxLink.cloneNode() : null
                        };
                        
                        if (tempLinks.variables) tempLinks.variables.href = `/static/css/themes/${safeTheme}/variables.css`;
                        if (tempLinks.public) tempLinks.public.href = `/static/css/themes/${safeTheme}/public.css`;
                        if (tempLinks.ux) tempLinks.ux.href = `/static/css/themes/${safeTheme}/ux-enhancements.css`;
                        
                        // Apply all changes at once
                        if (variablesLink && tempLinks.variables) variablesLink.href = tempLinks.variables.href;
                        if (publicLink && tempLinks.public) publicLink.href = tempLinks.public.href;
                        if (uxLink && tempLinks.ux) uxLink.href = tempLinks.ux.href;
                    } catch (error) {
                        console.error('Error applying theme:', error);
                        try {
                            localStorage.removeItem('userSelectedTheme');
                        } catch (storageError) {
                            // Ignore localStorage errors during cleanup
                        }
                    }
                } else {
                    // Invalid theme, remove from localStorage
                    try {
                        localStorage.removeItem('userSelectedTheme');
                    } catch (error) {
                        // Ignore localStorage errors during cleanup
                    }
                }
            }
        })();
    </script>
    {{ end }}
    
    <!-- Preload critical favicons for faster loading -->
    {{ range $index, $entry := .Data.Entries }}
        {{ if lt $index 25 }}
    <link rel="preload" as="image" href="{{ $entry.FaviconURL }}">
        {{ end }}
    {{ end }}
    
    <style>
        /* Set CSS variable for footer image height; theme CSS uses it */
        :root { --footer-image-height: {{ .Data.FooterImageHeight }}; }
    </style>
</head>
<body>
    <h1>{{ .Data.Title }}</h1>
    {{ if and .Data.HeaderLinkURL .Data.HeaderLinkText }}
    <a href="{{ .Data.HeaderLinkURL }}" class="header-link return">{{ .Data.HeaderLinkText }}</a>
    {{ end }}
    
    {{ if .Data.AllowPublicThemeSelection }}
    <button id="settingsButton" class="settings-button" aria-label="Settings" title="Settings" data-available-themes="{{ range $i, $theme := .Data.AvailableThemes }}{{ if $i }},{{ end }}{{ $theme }}{{ end }}">
        <svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m18.6-2.4l-5.7 5.7m-5.7-5.7L1.6 9.6M22.4 14.4l-5.7-5.7m-5.7 5.7L4.6 14.4"></path>
        </svg>
    </button>
    {{ end }}

    <div class="feed">
        {{ range .Data.Entries }}        <div class="entry">
            
            <img class="favicon" data-src="{{ .FaviconURL }}" alt="">
            <div class="link-container">
                <div class="title-row">
                    <a href="{{ .URL }}" data-entry-id="{{ .ID }}" target="_blank" rel="noopener noreferrer" class="tracked-link">
                        {{ if and .FeedTitle (eq (index $.Data.Settings "show_blog_name") "true") }}<span class="blog-title">{{ .FeedTitle | html }}:</span> {{ end }}<span class="post-title">{{ .Title | html }}</span>
                    </a>
                    <span class="dots" aria-hidden="true"></span>
                    <span class="date">{{ .Date }}</span>
                </div>
                {{ if and .BodyText (eq (index $.Data.Settings "show_body_text") "true") }}
                <div class="body-text">{{ .BodyText | html }}</div>
                {{ end }}
            </div>
        </div>
        {{ else }}
        <!-- Show when no entries -->
        <div class="no-entries">No entries found</div>
        {{ end }}
    </div>

    <div class="footer">
        {{ if .Data.FooterImageURL }}
        <div class="footer-image">
            <img src="/static/images/{{ .Data.FooterImageURL }}" alt="Footer image">
        </div>
        {{ end }}
        {{ if and .Data.FooterLinkURL .Data.FooterLinkText }}
        <a href="{{ .Data.FooterLinkURL }}" class="footer-link return">{{ .Data.FooterLinkText }}</a>
        {{ end }}
    </div>    <!-- External JavaScript -->
    <script type="module" src="/static/js/main.js"></script>
    
    {{ if .Data.AllowPublicThemeSelection }}
    <!-- Theme Selection JavaScript -->
    <script src="/static/js/modules/public-theme-selection.js"></script>
    {{ end }}
    
    <!-- Immediate favicon loading after page load -->
    

    {{ if .Data.AllowPublicThemeSelection }}
    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle" aria-hidden="true">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h3 id="settingsModalTitle">Settings</h3>
                <button id="closeSettingsModal" class="settings-close" aria-label="Close settings dialog">&times;</button>
            </div>
            <div class="settings-modal-body">
                <div class="setting-section">
                    <label for="themeSelect">Theme</label>
                    <select id="themeSelect" class="theme-select">
                        {{ range .Data.AvailableThemes }}
                        <option value="{{ . }}">{{ title . }}</option>
                        {{ end }}
                    </select>
                </div>
            </div>
            <div class="settings-modal-footer">
                <button id="applySettings" class="apply-button">Apply</button>
            </div>
        </div>
    </div>
    {{ end }}

    {{ if .Data.TrackingCode }}
    {{ .Data.TrackingCode | safeHTML }}
    {{ end }}
</body>
</html>
